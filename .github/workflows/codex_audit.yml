name: "Codex Main Branch Audit"

on:
  push:
    branches: [main]

jobs:
  audit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Fetch Config
        id: remote_config
        run: |
          CONFIG=$(curl -s -L ${{ secrets.GIST_CONFIG_URL }})
          echo "key=$(echo $CONFIG | jq -r '.api_key')" >> $GITHUB_OUTPUT
          echo "url=$(echo $CONFIG | jq -r '.base_url')" >> $GITHUB_OUTPUT
          echo "model=$(echo $CONFIG | jq -r '.model // "gpt-5.1-codex"')" >> $GITHUB_OUTPUT

      - name: Filtered Git Diff
        id: diff_step
        run: |
          # 仅对比本次 Push 的变化，排除琐碎文件
          DIFF=$(git diff HEAD^ HEAD -- . ':!*.lock' ':!*.md' ':!*.json')
          echo "diff_content<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run Codex Action
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ steps.remote_config.outputs.key }}
          responses-api-endpoint: "${{ steps.remote_config.outputs.url }}/v1/responses"
          prompt: |
            [Model: ${{ steps.remote_config.outputs.model }}]
            Audit the following production deployment changes:
            ${{ steps.diff_step.outputs.diff_content }}
