name: 质量守卫

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

jobs:
  quality-gate:
    name: 质量与构建校验
    runs-on: ubuntu-latest
    steps:
      - name: 拉取仓库代码
        uses: actions/checkout@v4

      - name: 安装 Node.js 环境
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: 安装依赖
        run: |
          if ! npm ci; then
            echo '检测到锁文件与环境不一致，改用 npm install 同步依赖～'
            npm install
          fi

      - name: 代码规范检查
        id: lint
        run: npm run lint
        continue-on-error: true

      - name: 单元测试
        id: test
        run: npm test
        continue-on-error: true

      - name: 构建 Netlify 产物
        id: build
        run: npm run build
        continue-on-error: true

      - name: 安全审计
        id: audit
        continue-on-error: true
        run: |
          npm audit --json > audit.json || echo '{"metadata":{"vulnerabilities":{}}}' > audit.json

      - name: 依赖更新检测
        id: outdated
        continue-on-error: true
        run: |
          npm outdated --json > outdated.json || echo '{}' > outdated.json

      - name: 汇总质量评分
        if: always()
        id: rating
        env:
          LINT_OUTCOME: ${{ steps.lint.outcome }}
          TEST_OUTCOME: ${{ steps.test.outcome }}
          BUILD_OUTCOME: ${{ steps.build.outcome }}
        run: |
          node <<'NODE'
          const fs = require('fs');

          const lintOutcome = process.env.LINT_OUTCOME ?? 'success';
          const testOutcome = process.env.TEST_OUTCOME ?? 'success';
          const buildOutcome = process.env.BUILD_OUTCOME ?? 'success';
          const threshold = 90;
          const breakdown = [];
          let score = 100;

          if (lintOutcome !== 'success') {
            breakdown.push({ metric: 'lint', penalty: 35 });
            score -= 35;
          }
          if (testOutcome !== 'success') {
            breakdown.push({ metric: 'test', penalty: 35 });
            score -= 35;
          }
          if (buildOutcome !== 'success') {
            breakdown.push({ metric: 'build', penalty: 30 });
            score -= 30;
          }

          let vulnerabilities = {};
          try {
            const raw = fs.readFileSync('audit.json', 'utf8');
            vulnerabilities = JSON.parse(raw)?.metadata?.vulnerabilities ?? {};
          } catch (error) {
            breakdown.push({ metric: 'audit', penalty: 5, note: 'parse_error' });
            score -= 5;
          }

          const severityWeights = { critical: 10, high: 7, moderate: 4, low: 2, info: 0 };
          let vulnPenalty = 0;
          for (const [severity, weight] of Object.entries(severityWeights)) {
            const count = Number(vulnerabilities?.[severity] ?? 0);
            if (count > 0) {
              vulnPenalty += count * weight;
            }
          }
          if (vulnPenalty > 0) {
            vulnPenalty = Math.min(vulnPenalty, 30);
            breakdown.push({ metric: 'vulnerabilities', penalty: vulnPenalty, vulnerabilities });
            score -= vulnPenalty;
          }

          let outdated = {};
          try {
            outdated = JSON.parse(fs.readFileSync('outdated.json', 'utf8')) ?? {};
          } catch (error) {
            breakdown.push({ metric: 'outdated', penalty: 5, note: 'parse_error' });
            score -= 5;
          }
          const outdatedCount = Object.keys(outdated).length;
          const deprecatedCount = Object.values(outdated).filter((item) => item?.deprecated).length;
          if (outdatedCount > 0) {
            const penalty = Math.min(outdatedCount * 2 + deprecatedCount * 3, 20);
            breakdown.push({ metric: 'dependency_freshness', penalty, outdatedCount, deprecatedCount });
            score -= penalty;
          }

          score = Math.max(0, score);
          let rating = 'F';
          if (score >= 95) rating = 'S';
          else if (score >= 90) rating = 'A';
          else if (score >= 80) rating = 'B';
          else if (score >= 70) rating = 'C';
          else if (score >= 60) rating = 'D';

          const payload = {
            timestamp: new Date().toISOString(),
            threshold,
            score,
            rating,
            breakdown,
            outcomes: {
              lint: lintOutcome,
              test: testOutcome,
              build: buildOutcome
            },
            vulnerabilities,
            outdatedSummary: {
              count: outdatedCount,
              deprecated: deprecatedCount
            }
          };

          fs.writeFileSync('quality-report.json', JSON.stringify(payload, null, 2));
          fs.writeFileSync('quality-summary.txt', `rating=${payload.rating}\nscore=${payload.score}\nthreshold=${payload.threshold}`);
          console.log(`质量评级：${payload.rating}（得分 ${payload.score}/100）`);
          console.log('扣分明细：', JSON.stringify(breakdown, null, 2));
          console.log('漏洞统计：', JSON.stringify(vulnerabilities));
          console.log('依赖陈旧情况：', JSON.stringify(outdated));

          if (process.env.GITHUB_OUTPUT) {
            const needsImprove = payload.score < threshold ? 'yes' : 'no';
            const lines = [
              `rating=${payload.rating}`,
              `score=${payload.score}`,
              `threshold=${threshold}`,
              `need_improvement=${needsImprove}`
            ];
            fs.appendFileSync(process.env.GITHUB_OUTPUT, `${lines.join('\n')}\n`);
          }
          NODE

      - name: 上传质量报告
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: quality-report
          path: |
            quality-report.json
            quality-summary.txt
          retention-days: 7

      - name: 若 lint 失败则终止
        if: steps.lint.outcome == 'failure'
        run: |
          echo 'ESLint 未通过，请修复后重试。'
          exit 1

      - name: 若测试失败则终止
        if: steps.test.outcome == 'failure'
        run: |
          echo '单元测试未通过，请修复后重试。'
          exit 1

      - name: 若构建失败则终止
        if: steps.build.outcome == 'failure'
        run: |
          echo '构建失败，请查看日志。'
          exit 1
