name: "Codex Intelligence Hub"

on:
  issue_comment:
    types: [created]
  push:
    branches: [main]

jobs:
  codex_brain:
    if: |
      github.event_name == 'push' || 
      (github.event.comment && contains(github.event.comment.body, '@codex'))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch Remote Intelligence (Gist)
        id: gist_config
        run: |
          # 1. è·å–æ ¸å¿ƒ JSON é…ç½®
          CONFIG=$(curl -s -f -L "${{ secrets.GIST_CONFIG_URL }}")
          if [ $? -ne 0 ]; then echo "æ— æ³•è¯»å– GIST_CONFIG_URL"; exit 1; fi

          KEY=$(echo "$CONFIG" | jq -r '.api_key')
          URL=$(echo "$CONFIG" | jq -r '.base_url')
          MODEL=$(echo "$CONFIG" | jq -r '.model // "gpt-5.1-codex"')
          AGENTS_URL=$(echo "$CONFIG" | jq -r '.agents_gist_url')
          PROMPTS_URL=$(echo "$CONFIG" | jq -r '.prompts_gist_url')

          # 2. å®‰å…¨è„±æ• (Key å’Œ Base URL å‡éšè—)
          echo "::add-mask::$KEY"
          echo "::add-mask::$URL"

          # 3. è®¾ç½®è¾“å‡ºå˜é‡ (GitHub è‡ªåŠ¨éšè—å·² add-mask çš„å†…å®¹)
          echo "api_key=$KEY" >> $GITHUB_OUTPUT
          echo "base_url=$URL" >> $GITHUB_OUTPUT
          echo "model=$MODEL" >> $GITHUB_OUTPUT

          # 4. ç¡®ä¿ç›®å½•å­˜åœ¨
          mkdir -p .github

          # 5. ä¸‹è½½èµ„äº§å¹¶å¢åŠ æ ¡éªŒ (é˜²æ­¢ URL ä¸ºç©ºå¯¼è‡´ curl exit 6)
          if [ "$AGENTS_URL" != "null" ] && [ -n "$AGENTS_URL" ]; then
            curl -s -f -L "$AGENTS_URL" -o .github/AGENTS.md || { echo "ä¸‹è½½ AGENTS.md å¤±è´¥"; exit 1; }
          fi

          if [ "$PROMPTS_URL" != "null" ] && [ -n "$PROMPTS_URL" ]; then
            curl -s -f -L "$PROMPTS_URL" -o .github/SYSTEM_PROMPTS.md || { echo "ä¸‹è½½ SYSTEM_PROMPTS.md å¤±è´¥"; exit 1; }
          fi

          echo "Intelligence assets synced successfully."

      - name: Prepare Context & Filter Diff
        id: context_builder
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # å®šä¹‰è¿‡æ»¤è§„åˆ™ (æ’é™¤é”æ–‡ä»¶ã€æ–‡æ¡£ã€å›¾ç‰‡ç­‰)
          FILTER=":!*.lock :!*-lock.json :!*.md :!*.svg :!*.png :!*.jpg"
          
          if [ "${{ github.event_name }}" == "push" ]; then
            # Main æ¨é€å®¡è®¡æ¨¡å¼
            DIFF=$(git diff HEAD^ HEAD -- . $FILTER | tail -c 10000)
            echo "mode=AUDIT" >> $GITHUB_OUTPUT
            echo "instruction=Perform a comprehensive code audit based on pr-review-comprehensive template." >> $GITHUB_OUTPUT
            echo "$DIFF" > context.txt
          elif [ "${{ github.event.issue.pull_request }}" != "null" ]; then
            # PR è¯„è®ºå®¡æŸ¥æ¨¡å¼
            DIFF=$(gh pr diff ${{ github.event.issue.number }} -- . $FILTER | tail -c 10000)
            echo "mode=PR_REVIEW" >> $GITHUB_OUTPUT
            echo "instruction=Act as a Senior Engineer. Follow the comprehensive review prompt." >> $GITHUB_OUTPUT
            echo "$DIFF" > context.txt
          else
            # Issue ä»»åŠ¡æ¨¡å¼ (ä¿®å¤/åŠŸèƒ½)
            ISSUE_BODY="${{ github.event.issue.body }}"
            TREE=$(find . -maxdepth 2 -not -path '*/.*')
            echo "mode=ISSUE_RESOLVE" >> $GITHUB_OUTPUT
            echo "instruction=Analyze the issue and provide a fix or implementation plan. Project Structure:\n$TREE" >> $GITHUB_OUTPUT
            echo "$ISSUE_BODY" > context.txt
          fi

      - name: OpenAI Codex Action (2025.11)
        id: codex
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ steps.gist_config.outputs.api_key }}
          model: ${{ steps.gist_config.outputs.model }}
          responses-api-endpoint: "${{ steps.gist_config.outputs.base_url }}/v1/responses"
          # åŠ¨æ€åŠ è½½è¿œç¨‹è·å–çš„è§’è‰²é…ç½®
          agents-config: "./github/AGENTS.md"
          prompt: |
            ### SYSTEM TEMPLATE (From Remote)
            $(cat .github/SYSTEM_PROMPTS.md)
            
            ### TASK
            Mode: ${{ steps.context_builder.outputs.mode }}
            Instruction: ${{ steps.context_builder.outputs.instruction }}
            User Comment: ${{ github.event.comment.body }}
            
            ### CONTEXT DATA
            $(cat context.txt)

      - name: Post Response
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # å°†ç»“æœå›å¸–ï¼ŒåŒºåˆ† PR å’Œ Issue
          RESPONSE_BODY="${{ steps.codex.outputs.final-message }}"
          gh issue comment ${{ github.event.issue.number }} --body "### ğŸ¤– Codex Hub Result
          $RESPONSE_BODY"
