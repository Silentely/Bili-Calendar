name: "Codex Intelligence Hub"

on:
  pull_request:
    types: [opened, synchronize]
  issue_comment:
    types: [created]

jobs:
  codex_brain:
    if: |
      github.event_name == 'pull_request' || 
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@codex'))
    
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch Remote Intelligence (Gist)
        id: gist_config
        run: |
          # 1. è·å– JSON é…ç½®
          CONFIG=$(curl -s -f -L "${{ secrets.GIST_CONFIG_URL }}")
          
          # æå–å¹¶è„±æ•
          KEY=$(echo "$CONFIG" | jq -r '.api_key')
          URL=$(echo "$CONFIG" | jq -r '.base_url')
          echo "::add-mask::$KEY"
          echo "::add-mask::$URL"
          
          echo "api_key=$KEY" >> $GITHUB_OUTPUT
          echo "base_url=$URL" >> $GITHUB_OUTPUT
          echo "model=$(echo "$CONFIG" | jq -r '.model // "gpt-5.2-codex"')" >> $GITHUB_OUTPUT
          
          # 2. ä¸‹è½½èµ„äº§ï¼ˆå¼ºåˆ¶åˆ›å»ºç›®å½•ï¼‰
          mkdir -p .github/prompts
          AGENTS_URL=$(echo "$CONFIG" | jq -r '.agents_gist_url')
          PROMPTS_URL=$(echo "$CONFIG" | jq -r '.prompts_gist_url')
          
          curl -s -f -L "$AGENTS_URL" -o .github/AGENTS.md || echo "No Agents file"
          curl -s -f -L "$PROMPTS_URL" -o .github/SYSTEM_PROMPTS.md || echo "No Prompts file"

      - name: Prepare Final Prompt
        id: prompt_builder
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          FILTER=":!*.lock :!*-lock.json :!*.md :!*.svg :!*.png :!*.jpg"
          
          # 1. æå– Diff æˆ– Issue å†…å®¹
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            CONTENT=$(git diff ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} -- . $FILTER | tail -c 8000)
            TITLE="PR Auto Review"
          elif [ "${{ github.event.issue.pull_request }}" != "null" ]; then
            CONTENT=$(gh pr diff ${{ github.event.issue.number }} -- . $FILTER | tail -c 8000)
            TITLE="PR Comment Task: ${{ github.event.comment.body }}"
          else
            CONTENT="${{ github.event.issue.body }}"
            TITLE="Issue Task: ${{ github.event.comment.body }}"
          fi

          # 2. è¯»å– System Prompt (å¤„ç†æ–‡ä»¶ä¸å­˜åœ¨çš„æƒ…å†µ)
          if [ -f ".github/SYSTEM_PROMPTS.md" ]; then
            SYSTEM_P=$(cat .github/SYSTEM_PROMPTS.md)
          else
            SYSTEM_P="Standard AI Assistant Mode"
          fi

          # 3. æ ¸å¿ƒï¼šåˆæˆæœ€ç»ˆ Prompt å¹¶å­˜å…¥ OUTPUT (è§£å†³ Shell æ³¨å…¥é—®é¢˜)
          echo "full_prompt<<EOF" >> $GITHUB_OUTPUT
          echo "--- SYSTEM INSTRUCTION ---" >> $GITHUB_OUTPUT
          echo "$SYSTEM_P" >> $GITHUB_OUTPUT
          echo "--- TASK CONTEXT ---" >> $GITHUB_OUTPUT
          echo "Mode: $TITLE" >> $GITHUB_OUTPUT
          echo "--- DATA CONTENT ---" >> $GITHUB_OUTPUT
          echo "$CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run OpenAI Codex Action
        id: codex
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ steps.gist_config.outputs.api_key }}
          model: ${{ steps.gist_config.outputs.model }}
          responses-api-endpoint: "${{ steps.gist_config.outputs.base_url }}/v1/responses"
          # ä½¿ç”¨ä¸‹è½½çš„ Agent é…ç½®
          agents-config: ".github/AGENTS.md"
          # ç›´æ¥ä½¿ç”¨ä¸Šä¸€æ­¥åˆæˆå¥½çš„å­—ç¬¦ä¸²ï¼Œä¸å†åœ¨ with ä¸­è¿è¡Œ cat æˆ– sed
          prompt: ${{ steps.prompt_builder.outputs.full_prompt }}

      - name: Post Results
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # åªæœ‰å½“ codex æœ‰è¾“å‡ºæ—¶æ‰å›å¸–
          RESULT="${{ steps.codex.outputs.final-message }}"
          if [ -n "$RESULT" ]; then
            gh issue comment ${{ github.event.issue.number || github.event.pull_request.number }} --body "### ğŸ¤– Codex Intelligence Result
            $RESULT"
          fi
