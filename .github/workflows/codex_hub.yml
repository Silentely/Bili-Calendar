name: "Codex Intelligence Hub"

on:
  # åœºæ™¯ 1: PR åˆ›å»ºæˆ–ä»£ç æ›´æ–°æ—¶è‡ªåŠ¨è§¦å‘
  pull_request:
    types: [opened, synchronize]
  # åœºæ™¯ 2: åœ¨ Issue æˆ– PR ä¸­å‘è¡¨è¯„è®ºæ—¶è§¦å‘
  issue_comment:
    types: [created]

jobs:
  codex_brain:
    # è§¦å‘é€»è¾‘ï¼šå¦‚æœæ˜¯ PR æ´»åŠ¨ï¼Œæˆ–è€…è¯„è®ºä¸­åŒ…å« @codex
    if: |
      github.event_name == 'pull_request' || 
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@codex'))
    
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch Remote Intelligence (Gist)
        id: gist_config
        run: |
          # 1. è·å–æ ¸å¿ƒ JSON é…ç½® (ç¡®ä¿ secrets.GIST_CONFIG_URL æ˜¯ Raw é“¾æ¥)
          CONFIG=$(curl -s -f -L "${{ secrets.GIST_CONFIG_URL }}")
          if [ $? -ne 0 ]; then echo "æ— æ³•è¯»å– GIST é…ç½®æ–‡ä»¶"; exit 1; fi

          KEY=$(echo "$CONFIG" | jq -r '.api_key')
          URL=$(echo "$CONFIG" | jq -r '.base_url')
          MODEL=$(echo "$CONFIG" | jq -r '.model // "gpt-5.1-codex"')
          AGENTS_URL=$(echo "$CONFIG" | jq -r '.agents_gist_url')
          PROMPTS_URL=$(echo "$CONFIG" | jq -r '.prompts_gist_url')

          # 2. å®‰å…¨è„±æ•ï¼šéšè— Key å’Œ Base URL
          echo "::add-mask::$KEY"
          echo "::add-mask::$URL"

          # 3. è®¾ç½®è¾“å‡º
          echo "api_key=$KEY" >> $GITHUB_OUTPUT
          echo "base_url=$URL" >> $GITHUB_OUTPUT
          echo "model=$MODEL" >> $GITHUB_OUTPUT
          
          # 4. å‡†å¤‡ç›®å½•å¹¶ä¸‹è½½èµ„äº§
          mkdir -p .github
          if [ "$AGENTS_URL" != "null" ]; then curl -s -f -L "$AGENTS_URL" -o .github/AGENTS.md; fi
          if [ "$PROMPTS_URL" != "null" ]; then curl -s -f -L "$PROMPTS_URL" -o .github/SYSTEM_PROMPTS.md; fi

      - name: Prepare Context
        id: context
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          FILTER=":!*.lock :!*-lock.json :!*.md :!*.svg :!*.png :!*.jpg"
          
          # åˆ¤æ–­åœºæ™¯
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # PR è‡ªåŠ¨è¿è¡Œåœºæ™¯
            DIFF=$(git diff ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} -- . $FILTER | tail -c 10000)
            echo "mode=AUTO_PR_REVIEW" >> $GITHUB_OUTPUT
            echo "instruction=è‡ªåŠ¨å¯¹æœ¬æ¬¡ PR å˜æ›´è¿›è¡Œå…¨é¢å®¡æŸ¥ã€‚" >> $GITHUB_OUTPUT
            echo "$DIFF" > context.txt
          elif [ "${{ github.event.issue.pull_request }}" != "null" ]; then
            # PR è¯„è®ºå¬å”¤åœºæ™¯
            DIFF=$(gh pr diff ${{ github.event.issue.number }} -- . $FILTER | tail -c 10000)
            echo "mode=PR_COMMENT_TASK" >> $GITHUB_OUTPUT
            echo "instruction=å“åº” PR ä¸­çš„ç”¨æˆ·æŒ‡ä»¤: ${{ github.event.comment.body }}" >> $GITHUB_OUTPUT
            echo "$DIFF" > context.txt
          else
            # Issue è¯„è®ºå¬å”¤åœºæ™¯
            echo "mode=ISSUE_TASK" >> $GITHUB_OUTPUT
            echo "instruction=åˆ†æ Issue å¹¶æ ¹æ®ç”¨æˆ·æŒ‡ä»¤æä¾›æ–¹æ¡ˆ: ${{ github.event.comment.body }}" >> $GITHUB_OUTPUT
            echo "${{ github.event.issue.body }}" > context.txt
          fi

      - name: Run OpenAI Codex Action
        id: codex
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ steps.gist_config.outputs.api_key }}
          model: ${{ steps.gist_config.outputs.model }}
          # åŠ¨æ€æ‹¼æ¥ç«¯ç‚¹
          responses-api-endpoint: "${{ steps.gist_config.outputs.base_url }}/v1/responses"
          agents-config: "./github/AGENTS.md"
          prompt: |
            $(cat .github/SYSTEM_PROMPTS.md || echo "Standard Review Mode")
            
            [Context Mode: ${{ steps.context.outputs.mode }}]
            [Instruction: ${{ steps.context.outputs.instruction }}]
            
            Data Content:
            $(cat context.txt)

      - name: Post Results
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RESULT="${{ steps.codex.outputs.final-message }}"
          # å¦‚æœæ˜¯ PR è‡ªåŠ¨è§¦å‘ï¼Œåœ¨ PR åˆ—è¡¨é¡µå‘è¯„è®ºï¼›å¦‚æœæ˜¯ Issue/Commentï¼Œç›´æ¥å›å¸–
          gh issue comment ${{ github.event.issue.number || github.event.pull_request.number }} --body "### ğŸ¤– Codex Intelligence Result
          $RESULT"
