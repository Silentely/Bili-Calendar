# æ¶æ„æ”¹è¿›ä¸æœªæ¥å±•æœ› (Architecture Improvements & Future Vision)

## ğŸ“ å½“å‰æ¶æ„æ¦‚è¿°

### ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ç”¨æˆ·å±‚ (Users)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Webæµè§ˆå™¨  â”‚  ç§»åŠ¨è®¾å¤‡  â”‚  æ—¥å†å®¢æˆ·ç«¯ (Apple Calendarç­‰)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ HTTPS
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    è´Ÿè½½å‡è¡¡å±‚ (å¯é€‰)                          â”‚
â”‚                  (Nginx / Cloudflare)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åº”ç”¨æœåŠ¡å±‚ (Express.js)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ é™æ€æ–‡ä»¶æœåŠ¡ (HTML/CSS/JS)                                â”‚
â”‚  â€¢ API è·¯ç”± (/api/bangumi/:uid)                              â”‚
â”‚  â€¢ ICS ç”Ÿæˆ (/:uid.ics)                                      â”‚
â”‚  â€¢ é€Ÿç‡é™åˆ¶ä¸­é—´ä»¶                                             â”‚
â”‚  â€¢ å‹ç¼©ä¸­é—´ä»¶                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å·¥å…·å±‚ (Utils)                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ HTTP å®¢æˆ·ç«¯ (Axios + è¿æ¥æ± )                              â”‚
â”‚  â€¢ è¯·æ±‚å»é‡ç®¡ç†å™¨                                             â”‚
â”‚  â€¢ é€Ÿç‡é™åˆ¶å™¨ (å†…å­˜)                                          â”‚
â”‚  â€¢ æ—¶é—´å¤„ç†å·¥å…·                                               â”‚
â”‚  â€¢ ICS æ ¼å¼åŒ–å·¥å…·                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 å¤–éƒ¨æœåŠ¡ (External Services)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚           Bilibili API (api.bilibili.com)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å½“å‰æŠ€æœ¯æ ˆ

- **è¿è¡Œæ—¶**: Node.js 18+
- **Web æ¡†æ¶**: Express.js
- **HTTP å®¢æˆ·ç«¯**: Axios
- **éƒ¨ç½²å¹³å°**: 
  - Docker (è‡ªæ‰˜ç®¡)
  - Netlify Functions (Serverless)
- **å‰ç«¯**: åŸç”Ÿ JavaScript (æ— æ¡†æ¶)
- **å­˜å‚¨**: å†…å­˜ (é€Ÿç‡é™åˆ¶)ã€LocalStorage (å‰ç«¯ç¼“å­˜)

---

## ğŸ¯ æ¶æ„æ”¹è¿›å»ºè®®

### å»ºè®® 1: å¼•å…¥ç¼“å­˜å±‚ - Redis

#### å½“å‰é—®é¢˜

1. **é€Ÿç‡é™åˆ¶çŠ¶æ€ä¸¢å¤±**: 
   - å®¹å™¨é‡å¯åé™æµè®°å½•æ¶ˆå¤±
   - Netlify Functions æ— çŠ¶æ€ç‰¹æ€§å¯¼è‡´é™æµæ— æ•ˆ

2. **æ— æ³•å®ç°åˆ†å¸ƒå¼**:
   - å¤šå®ä¾‹éƒ¨ç½²æ—¶ï¼Œé™æµä¸å…±äº«
   - æ— æ³•å®ç°å…¨å±€é…é¢ç®¡ç†

3. **è¯·æ±‚å»é‡å±€é™æ€§**:
   - ä»…åœ¨å•ä¸ªè¿›ç¨‹å†…æœ‰æ•ˆ
   - å¤šå®ä¾‹æ— æ³•å…±äº«å»é‡çŠ¶æ€

#### è§£å†³æ–¹æ¡ˆ: Redis ç¼“å­˜å±‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åº”ç”¨æœåŠ¡å±‚ (å¤šå®ä¾‹)                        â”‚
â”‚                   Instance 1, 2, 3...                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Redis ç¼“å­˜é›†ç¾¤                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ é€Ÿç‡é™åˆ¶çŠ¶æ€ (TTL: 1å°æ—¶)                                  â”‚
â”‚  â€¢ è¯·æ±‚å»é‡é” (TTL: 30ç§’)                                     â”‚
â”‚  â€¢ API å“åº”ç¼“å­˜ (TTL: 5åˆ†é’Ÿ)                                  â”‚
â”‚  â€¢ ICS æ–‡ä»¶ç¼“å­˜ (TTL: 1å°æ—¶)                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å®ç°ç¤ºä¾‹

```javascript
// utils/rate-limiter-redis.cjs
const redis = require('redis');

class RedisRateLimiter {
  constructor(redisClient) {
    this.redis = redisClient;
    this.MAX_REQUESTS = 3;
    this.TIME_WINDOW = 3600; // ç§’
  }

  async check(ip) {
    const key = `rate_limit:${ip}`;
    const count = await this.redis.incr(key);
    
    if (count === 1) {
      await this.redis.expire(key, this.TIME_WINDOW);
    }
    
    return count <= this.MAX_REQUESTS;
  }

  async getRemainingRequests(ip) {
    const key = `rate_limit:${ip}`;
    const count = await this.redis.get(key);
    return Math.max(0, this.MAX_REQUESTS - (count || 0));
  }
}
```

#### æ”¶ç›Š

- âœ… æŒä¹…åŒ–é™æµçŠ¶æ€
- âœ… æ”¯æŒå¤šå®ä¾‹éƒ¨ç½²
- âœ… å…¨å±€è¯·æ±‚å»é‡
- âœ… å“åº”ç¼“å­˜ï¼Œå‡å°‘ API è°ƒç”¨
- âœ… æ›´å¥½çš„æ€§èƒ½ç›‘æ§èƒ½åŠ›

#### æˆæœ¬ä¼°ç®—

- **Redis Cloud**: $0-5/æœˆï¼ˆå…è´¹å±‚ 30MBï¼‰
- **Upstash Redis**: $0-10/æœˆï¼ˆæŒ‰è¯·æ±‚ä»˜è´¹ï¼‰
- **è‡ªæ‰˜ç®¡ Redis**: æœåŠ¡å™¨æˆæœ¬

---

### å»ºè®® 2: å¾®æœåŠ¡æ¶æ„æ¼”è¿›

#### å½“å‰æ¶æ„ç“¶é¢ˆ

1. **å•ä½“åº”ç”¨**: æ‰€æœ‰åŠŸèƒ½è€¦åˆåœ¨ä¸€èµ·
2. **æ‰©å±•å›°éš¾**: æ— æ³•é’ˆå¯¹ç‰¹å®šåŠŸèƒ½ç‹¬ç«‹æ‰©å±•
3. **éƒ¨ç½²é£é™©**: ä»»ä½•æ›´æ”¹éƒ½éœ€è¦é‡æ–°éƒ¨ç½²æ•´ä¸ªåº”ç”¨

#### å¾®æœåŠ¡æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    API ç½‘å…³ (API Gateway)                     â”‚
â”‚              (Kong / AWS API Gateway / Nginx)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ ç»Ÿä¸€å…¥å£                                                   â”‚
â”‚  â€¢ è·¯ç”±åˆ†å‘                                                   â”‚
â”‚  â€¢ è®¤è¯æˆæƒ                                                   â”‚
â”‚  â€¢ é€Ÿç‡é™åˆ¶                                                   â”‚
â”‚  â€¢ è¯·æ±‚æ—¥å¿—                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚             â”‚             â”‚             â”‚
       â–¼             â–¼             â–¼             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é™æ€æ–‡ä»¶  â”‚  â”‚ ç•ªå‰§API   â”‚  â”‚ ICSç”Ÿæˆ   â”‚  â”‚ é€šçŸ¥æœåŠ¡  â”‚
â”‚ æœåŠ¡      â”‚  â”‚ æœåŠ¡      â”‚  â”‚ æœåŠ¡      â”‚  â”‚ (æ–°)      â”‚
â”‚          â”‚  â”‚          â”‚  â”‚          â”‚  â”‚          â”‚
â”‚ Express  â”‚  â”‚ Express  â”‚  â”‚ Express  â”‚  â”‚ Express  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚             â”‚
                    â–¼             â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   å…±äº«æœåŠ¡ (Shared)   â”‚
              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
              â”‚ â€¢ Redis ç¼“å­˜         â”‚
              â”‚ â€¢ æ¶ˆæ¯é˜Ÿåˆ— (RabbitMQ)â”‚
              â”‚ â€¢ ç›‘æ§æœåŠ¡           â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æœåŠ¡æ‹†åˆ†å»ºè®®

| æœåŠ¡åç§° | èŒè´£ | æŠ€æœ¯æ ˆ | æ‰©å±•ä¼˜å…ˆçº§ |
|---------|------|--------|-----------|
| **é™æ€æ–‡ä»¶æœåŠ¡** | æ‰˜ç®¡å‰ç«¯èµ„æº | Nginx / CDN | ä½ |
| **ç•ªå‰§ API æœåŠ¡** | è·å–å’Œç¼“å­˜ Bç«™æ•°æ® | Node.js | é«˜ |
| **ICS ç”ŸæˆæœåŠ¡** | ç”Ÿæˆæ—¥å†æ–‡ä»¶ | Node.js | ä¸­ |
| **é€šçŸ¥æœåŠ¡** | Webhook / é‚®ä»¶é€šçŸ¥ | Node.js | ä½ |
| **åˆ†ææœåŠ¡** | ç”¨æˆ·è¡Œä¸ºåˆ†æ | Python | ä½ |

#### å®æ–½è·¯å¾„

**é˜¶æ®µ 1: å‡†å¤‡æœŸï¼ˆ1-2ä¸ªæœˆï¼‰**
- æå–å…±äº«é…ç½®å’Œå·¥å…·
- å»ºç«‹æœåŠ¡é—´é€šä¿¡åè®®
- æ­å»ºå¼€å‘å’Œæµ‹è¯•ç¯å¢ƒ

**é˜¶æ®µ 2: è¯•ç‚¹æœŸï¼ˆ2-3ä¸ªæœˆï¼‰**
- æ‹†åˆ†å‡ºç¬¬ä¸€ä¸ªå¾®æœåŠ¡ï¼ˆå»ºè®®ï¼šICS ç”ŸæˆæœåŠ¡ï¼‰
- å»ºç«‹ CI/CD æµç¨‹
- ç›‘æ§å’Œæ—¥å¿—ç³»ç»Ÿ

**é˜¶æ®µ 3: å…¨é¢æ¨å¹¿ï¼ˆ3-6ä¸ªæœˆï¼‰**
- é€æ­¥æ‹†åˆ†å…¶ä»–æœåŠ¡
- ä¼˜åŒ–æœåŠ¡é—´é€šä¿¡
- æ€§èƒ½è°ƒä¼˜

#### æ”¶ç›Š

- âœ… ç‹¬ç«‹æ‰©å±•ï¼šæŒ‰éœ€æ‰©å±•é«˜è´Ÿè½½æœåŠ¡
- âœ… æŠ€æœ¯è‡ªç”±ï¼šä¸åŒæœåŠ¡å¯ç”¨ä¸åŒæŠ€æœ¯æ ˆ
- âœ… å®¹é”™æ€§ï¼šå•ä¸ªæœåŠ¡æ•…éšœä¸å½±å“å…¨å±€
- âœ… å¼€å‘æ•ˆç‡ï¼šå›¢é˜Ÿå¯å¹¶è¡Œå¼€å‘
- âœ… éƒ¨ç½²çµæ´»ï¼šç‹¬ç«‹éƒ¨ç½²ï¼Œé™ä½é£é™©

#### æŒ‘æˆ˜

- âš ï¸ å¤æ‚åº¦å¢åŠ ï¼šéœ€è¦æœåŠ¡ç¼–æ’å’Œç›‘æ§
- âš ï¸ è¿ç»´æˆæœ¬ï¼šéœ€è¦æ›´å¤šåŸºç¡€è®¾æ–½
- âš ï¸ è°ƒè¯•å›°éš¾ï¼šåˆ†å¸ƒå¼ç³»ç»Ÿè°ƒè¯•æ›´å¤æ‚

---

### å»ºè®® 3: CDN å’Œè¾¹ç¼˜è®¡ç®—

#### å½“å‰é—®é¢˜

1. **å…¨çƒè®¿é—®å»¶è¿Ÿ**: æœåŠ¡å™¨åœ°ç†ä½ç½®å›ºå®š
2. **å¸¦å®½æˆæœ¬**: æ‰€æœ‰è¯·æ±‚éƒ½ç»è¿‡æºæœåŠ¡å™¨
3. **DDoS é£é™©**: ç¼ºä¹è¾¹ç¼˜ä¿æŠ¤

#### CDN æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å…¨çƒç”¨æˆ· (Global Users)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   CDN è¾¹ç¼˜èŠ‚ç‚¹ (Edge Nodes)                   â”‚
â”‚              (Cloudflare / AWS CloudFront)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ é™æ€èµ„æºç¼“å­˜ (HTML/CSS/JS/å›¾ç‰‡)                            â”‚
â”‚  â€¢ ICS æ–‡ä»¶ç¼“å­˜ (çŸ­TTL: 1å°æ—¶)                                â”‚
â”‚  â€¢ DDoS ä¿æŠ¤                                                  â”‚
â”‚  â€¢ SSL/TLS ç»ˆç»“                                               â”‚
â”‚  â€¢ æ™ºèƒ½è·¯ç”± (å°±è¿‘è®¿é—®)                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ Cache Miss
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æºæœåŠ¡å™¨ (Origin Server)                    â”‚
â”‚                     Bili-Calendar API                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### è¾¹ç¼˜è®¡ç®—ä¼˜åŒ–

ä½¿ç”¨ **Cloudflare Workers** æˆ– **AWS Lambda@Edge** åœ¨è¾¹ç¼˜å¤„ç†è¯·æ±‚ï¼š

```javascript
// Cloudflare Worker ç¤ºä¾‹
addEventListener('fetch', event => {
  event.respondWith(handleRequest(event.request));
});

async function handleRequest(request) {
  const url = new URL(request.url);
  
  // é™æ€èµ„æºç›´æ¥ä» CDN è¿”å›
  if (url.pathname.match(/\.(css|js|png|jpg|ico)$/)) {
    return fetch(request);
  }
  
  // ICS æ–‡ä»¶å°è¯•ä» KV ç¼“å­˜è¯»å–
  if (url.pathname.endsWith('.ics')) {
    const cacheKey = `ics:${url.pathname}`;
    const cached = await ICS_CACHE.get(cacheKey);
    
    if (cached) {
      return new Response(cached, {
        headers: {
          'Content-Type': 'text/calendar',
          'Cache-Control': 'public, max-age=3600',
        }
      });
    }
  }
  
  // å…¶ä»–è¯·æ±‚è½¬å‘åˆ°æºæœåŠ¡å™¨
  return fetch(request);
}
```

#### å®æ–½å»ºè®®

| CDN æä¾›å•† | é€‚ç”¨åœºæ™¯ | å…è´¹é¢åº¦ | æˆæœ¬ |
|-----------|---------|----------|------|
| **Cloudflare** | å…¨çƒåˆ†å‘ã€DDoS ä¿æŠ¤ | æ— é™æµé‡ | $0-20/æœˆ |
| **AWS CloudFront** | AWS ç”Ÿæ€é›†æˆ | 1TB/æœˆ | $0.085/GB |
| **Vercel Edge** | Jamstack åº”ç”¨ | 100GB/æœˆ | $0-20/æœˆ |

#### æ”¶ç›Š

- âœ… å…¨çƒè®¿é—®å»¶è¿Ÿé™ä½ 50-80%
- âœ… å¸¦å®½æˆæœ¬é™ä½ 60-90%
- âœ… DDoS é˜²æŠ¤èƒ½åŠ›æ˜¾è‘—æå‡
- âœ… æºæœåŠ¡å™¨è´Ÿè½½é™ä½ 70%+

---

## ğŸš€ æœªæ¥åŠŸèƒ½å»ºè®®

### åŠŸèƒ½ 1: Webhook é€šçŸ¥ç³»ç»Ÿ

#### åŠŸèƒ½æè¿°

å½“ç”¨æˆ·è¿½ç•ªåˆ—è¡¨æ›´æ–°æ—¶ï¼Œè‡ªåŠ¨é€šè¿‡ Webhook é€šçŸ¥ç¬¬ä¸‰æ–¹æœåŠ¡ã€‚

#### ä½¿ç”¨åœºæ™¯

- Discord/Telegram æœºå™¨äººé€šçŸ¥
- IFTTT é›†æˆ
- è‡ªåŠ¨åŒ–å·¥ä½œæµè§¦å‘
- ç§»åŠ¨åº”ç”¨æ¨é€

#### æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            å®šæ—¶ä»»åŠ¡ (Cron Job / AWS EventBridge)             â”‚
â”‚                   æ¯å°æ—¶æ£€æŸ¥æ›´æ–°                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ›´æ–°æ£€æµ‹æœåŠ¡                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. è·å–ç”¨æˆ·è¿½ç•ªåˆ—è¡¨                                          â”‚
â”‚  2. å¯¹æ¯”ä¸Šæ¬¡å¿«ç…§ (Redis)                                      â”‚
â”‚  3. æ£€æµ‹æ–°å¢/æ›´æ–°/å®Œç»“ç•ªå‰§                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ æœ‰æ›´æ–°
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 æ¶ˆæ¯é˜Ÿåˆ— (RabbitMQ / SQS)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Webhook åˆ†å‘æœåŠ¡                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ é‡è¯•æœºåˆ¶ (æŒ‡æ•°é€€é¿)                                        â”‚
â”‚  â€¢ é€Ÿç‡é™åˆ¶                                                   â”‚
â”‚  â€¢ å¤±è´¥é€šçŸ¥                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ç”¨æˆ·é…ç½®çš„ Webhook ç«¯ç‚¹                          â”‚
â”‚           (Discord/Telegram/IFTTT/Custom)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### API è®¾è®¡

```javascript
// æ³¨å†Œ Webhook
POST /api/webhooks
{
  "uid": "123456",
  "url": "https://discord.com/api/webhooks/...",
  "events": ["new_episode", "series_complete"],
  "secret": "your_secret_key"
}

// Webhook è´Ÿè½½ç¤ºä¾‹
POST https://your-webhook-url.com
{
  "event": "new_episode",
  "timestamp": "2024-01-01T12:00:00Z",
  "data": {
    "uid": "123456",
    "anime": {
      "title": "è‘¬é€çš„èŠ™è‰è²",
      "season_id": 12345,
      "episode": 12,
      "broadcast_time": "2024-01-01T12:00:00Z"
    }
  },
  "signature": "sha256=..."
}
```

---

### åŠŸèƒ½ 2: è‡ªå®šä¹‰æ—¥å†è§„åˆ™

#### åŠŸèƒ½æè¿°

å…è®¸ç”¨æˆ·è‡ªå®šä¹‰ç­›é€‰è§„åˆ™å’Œæ—¥å†æ˜¾ç¤ºæ–¹å¼ã€‚

#### åŠŸèƒ½ç‰¹æ€§

1. **é«˜çº§ç­›é€‰**:
   - æŒ‰æ ‡ç­¾ç­›é€‰ï¼ˆå¦‚"ç•ªå‰§"ã€"å›½åˆ›"ï¼‰
   - æŒ‰è¯„åˆ†ç­›é€‰
   - æŒ‰æ›´æ–°çŠ¶æ€ç­›é€‰
   - è‡ªå®šä¹‰æ’é™¤åˆ—è¡¨

2. **è‡ªå®šä¹‰æ˜¾ç¤º**:
   - è‡ªå®šä¹‰äº‹ä»¶æ ‡é¢˜æ ¼å¼
   - è‡ªå®šä¹‰æè¿°å†…å®¹
   - è‡ªå®šä¹‰æé†’æ—¶é—´
   - é¢œè‰²ç¼–ç ï¼ˆæŒ‰æ ‡ç­¾ï¼‰

3. **æ‰¹é‡ç®¡ç†**:
   - ä¸€é”®è®¢é˜…çƒ­é—¨ç•ªå‰§
   - æ‰¹é‡å¯¼å…¥/å¯¼å‡ºé…ç½®
   - åˆ†ç»„ç®¡ç†

#### API è®¾è®¡

```javascript
// åˆ›å»ºè‡ªå®šä¹‰è§„åˆ™
POST /api/calendar-rules
{
  "uid": "123456",
  "name": "æˆ‘çš„è¿½ç•ªè§„åˆ™",
  "filters": {
    "types": ["ç•ªå‰§", "å›½åˆ›"],
    "minRating": 8.0,
    "excludeTitles": ["æŸæŸç•ªå‰§"]
  },
  "display": {
    "titleFormat": "{title} - ç¬¬{episode}è¯",
    "reminderMinutes": 30,
    "colorByTag": true
  }
}

// ç”Ÿæˆè‡ªå®šä¹‰ ICS
GET /api/custom-calendar/:ruleId.ics
```

#### å®ç°æŠ€æœ¯

- **å‰ç«¯**: React + TypeScriptï¼ˆé‡æ„å‰ç«¯ï¼‰
- **åç«¯**: è§„åˆ™å¼•æ“ + æ¨¡æ¿ç³»ç»Ÿ
- **å­˜å‚¨**: MongoDB / PostgreSQLï¼ˆå­˜å‚¨ç”¨æˆ·è§„åˆ™ï¼‰

---

### åŠŸèƒ½ 3: æ•°æ®åˆ†æå’Œæ´å¯Ÿ

#### åŠŸèƒ½æè¿°

æä¾›ç•ªå‰§è¿½ç•ªè¶‹åŠ¿åˆ†æå’Œä¸ªæ€§åŒ–æ¨èã€‚

#### åˆ†æç»´åº¦

1. **ç”¨æˆ·åˆ†æ**:
   - è¿½ç•ªåå¥½åˆ†æ
   - è§‚çœ‹æ—¶é—´åˆ†å¸ƒ
   - å®Œæˆç‡ç»Ÿè®¡

2. **ç•ªå‰§åˆ†æ**:
   - çƒ­é—¨ç•ªå‰§æ’è¡Œ
   - è¿½ç•ªäººæ•°è¶‹åŠ¿
   - è¯„åˆ†åˆ†å¸ƒ

3. **æ¨èç³»ç»Ÿ**:
   - åŸºäºååŒè¿‡æ»¤çš„æ¨è
   - åŸºäºæ ‡ç­¾çš„ç›¸ä¼¼æ¨è
   - å­£åº¦æ–°ç•ªæ¨è

#### æŠ€æœ¯æ ˆ

- **æ•°æ®æ”¶é›†**: Node.js (API æ—¥å¿—)
- **æ•°æ®å­˜å‚¨**: ClickHouse / Elasticsearch
- **æ•°æ®åˆ†æ**: Python (Pandas, Scikit-learn)
- **å¯è§†åŒ–**: D3.js / Chart.js

#### ç¤ºä¾‹ API

```javascript
// è·å–ä¸ªäººè¿½ç•ªç»Ÿè®¡
GET /api/analytics/user/:uid
{
  "totalAnime": 42,
  "completedAnime": 15,
  "averageRating": 8.5,
  "favoriteGenres": ["å¥‡å¹»", "å†’é™©", "æ²»æ„ˆ"],
  "weeklyDistribution": [3, 5, 2, 4, 6, 8, 10]
}

// è·å–æ¨èç•ªå‰§
GET /api/recommendations/:uid
{
  "recommendations": [
    {
      "title": "æ¨èç•ªå‰§1",
      "reason": "å› ä¸ºä½ å–œæ¬¢ã€Šè‘¬é€çš„èŠ™è‰è²ã€‹",
      "similarity": 0.85
    }
  ]
}
```

---

## ğŸ“Š æ‰©å±•æ€§ç­–ç•¥

### æ¨ªå‘æ‰©å±• (Horizontal Scaling)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    è´Ÿè½½å‡è¡¡å™¨ (HAProxy)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚             â”‚             â”‚             â”‚
       â–¼             â–¼             â–¼             â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”
   â”‚ App1 â”‚      â”‚ App2 â”‚      â”‚ App3 â”‚      â”‚ App4 â”‚
   â””â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”˜
       â”‚             â”‚             â”‚             â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚   Redis    â”‚
                   â”‚  Cluster   â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è‡ªåŠ¨æ‰©å±•ç­–ç•¥

**Kubernetes HPA (æ°´å¹³è‡ªåŠ¨æ‰©å±•)**:

```yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: bili-calendar-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: bili-calendar
  minReplicas: 2
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
```

### å®¹é‡è§„åˆ’

| æŒ‡æ ‡ | å°è§„æ¨¡ | ä¸­è§„æ¨¡ | å¤§è§„æ¨¡ |
|------|--------|--------|--------|
| **æ—¥æ´»ç”¨æˆ·** | <1,000 | 1,000-10,000 | >10,000 |
| **æ—¥è¯·æ±‚é‡** | <10,000 | 10,000-100,000 | >100,000 |
| **å®ä¾‹æ•°é‡** | 1-2 | 3-5 | 5-20 |
| **Redis å†…å­˜** | 256MB | 1GB | 4GB+ |
| **æ•°æ®åº“** | SQLite | PostgreSQL | PostgreSQL + è¯»å‰¯æœ¬ |
| **æœˆæˆæœ¬** | $0-20 | $50-200 | $200-1000 |

---

## ğŸ”’ å®‰å…¨æ€§å¢å¼º

### 1. API å®‰å…¨

```javascript
// API å¯†é’¥è®¤è¯
app.use('/api', (req, res, next) => {
  const apiKey = req.headers['x-api-key'];
  
  if (!apiKey || !validateApiKey(apiKey)) {
    return res.status(401).json({
      error: 'Unauthorized',
      message: 'Invalid or missing API key'
    });
  }
  
  next();
});

// è¯·æ±‚ç­¾åéªŒè¯
function verifySignature(payload, signature, secret) {
  const expectedSignature = crypto
    .createHmac('sha256', secret)
    .update(payload)
    .digest('hex');
  
  return crypto.timingSafeEqual(
    Buffer.from(signature),
    Buffer.from(expectedSignature)
  );
}
```

### 2. IP ç™½åå•/é»‘åå•

```javascript
// Redis å­˜å‚¨é»‘åå•
const IPBlacklist = {
  async isBlocked(ip) {
    return await redis.sismember('ip_blacklist', ip);
  },
  
  async block(ip, reason, duration = 86400) {
    await redis.sadd('ip_blacklist', ip);
    await redis.setex(`ip_block_reason:${ip}`, duration, reason);
  }
};
```

### 3. å†…å®¹å®‰å…¨ç­–ç•¥ (CSP) å¢å¼º

```javascript
const helmet = require('helmet');

app.use(helmet.contentSecurityPolicy({
  directives: {
    defaultSrc: ["'self'"],
    scriptSrc: ["'self'", "'unsafe-inline'", "cdn.jsdelivr.net"],
    styleSrc: ["'self'", "'unsafe-inline'", "cdn.jsdelivr.net"],
    imgSrc: ["'self'", "data:", "https:"],
    connectSrc: ["'self'", "api.bilibili.com"],
    fontSrc: ["'self'", "data:", "cdn.jsdelivr.net"],
    objectSrc: ["'none'"],
    mediaSrc: ["'none'"],
    frameSrc: ["'none'"],
  }
}));
```

---

## ğŸ“ˆ ç›‘æ§å’Œå¯è§‚æµ‹æ€§

### ç›‘æ§æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åº”ç”¨æœåŠ¡ (App Services)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚             â”‚             â”‚             â”‚
       â”‚ Metrics     â”‚ Logs        â”‚ Traces      â”‚ Alerts
       â–¼             â–¼             â–¼             â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”
   â”‚Prome-â”‚      â”‚ ELK  â”‚      â”‚Jaegerâ”‚      â”‚Alert-â”‚
   â”‚theus â”‚      â”‚Stack â”‚      â”‚      â”‚      â”‚managerâ”‚
   â””â”€â”€â”¬â”€â”€â”€â”˜      â””â”€â”€â”¬â”€â”€â”€â”˜      â””â”€â”€â”¬â”€â”€â”€â”˜      â””â”€â”€â”¬â”€â”€â”€â”˜
      â”‚             â”‚             â”‚             â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚  Grafana   â”‚
                   â”‚ Dashboard  â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®æŒ‡æ ‡

**é»„é‡‘ä¿¡å· (Golden Signals)**:

1. **å»¶è¿Ÿ (Latency)**:
   - P50, P95, P99 å“åº”æ—¶é—´
   - åˆ†ç«¯ç‚¹ç»Ÿè®¡

2. **æµé‡ (Traffic)**:
   - æ¯ç§’è¯·æ±‚æ•° (RPS)
   - å¸¦å®½ä½¿ç”¨

3. **é”™è¯¯ (Errors)**:
   - 4xx/5xx é”™è¯¯ç‡
   - è¶…æ—¶ç‡

4. **é¥±å’Œåº¦ (Saturation)**:
   - CPU ä½¿ç”¨ç‡
   - å†…å­˜ä½¿ç”¨ç‡
   - è¿æ¥æ± ä½¿ç”¨ç‡

---

## ğŸ“ æ€»ç»“

æœ¬æ–‡æ¡£æå‡ºäº†ä¸‰å¤§æ¶æ„æ”¹è¿›æ–¹å‘å’Œä¸‰ä¸ªæœªæ¥åŠŸèƒ½å»ºè®®ï¼š

### æ¶æ„æ”¹è¿›
1. **Redis ç¼“å­˜å±‚**: è§£å†³åˆ†å¸ƒå¼å’ŒæŒä¹…åŒ–é—®é¢˜
2. **å¾®æœåŠ¡æ¶æ„**: æå‡æ‰©å±•æ€§å’Œå®¹é”™æ€§
3. **CDN + è¾¹ç¼˜è®¡ç®—**: ä¼˜åŒ–å…¨çƒè®¿é—®æ€§èƒ½

### æœªæ¥åŠŸèƒ½
1. **Webhook é€šçŸ¥**: å®æ—¶æ›´æ–°æ¨é€
2. **è‡ªå®šä¹‰è§„åˆ™**: ä¸ªæ€§åŒ–ä½“éªŒ
3. **æ•°æ®åˆ†æ**: æ™ºèƒ½æ¨è

### å®æ–½ä¼˜å…ˆçº§

**é«˜ä¼˜å…ˆçº§**ï¼ˆ3-6ä¸ªæœˆï¼‰:
- âœ… å¼•å…¥ Redis ç¼“å­˜
- âœ… CDN æ¥å…¥
- âœ… ç›‘æ§ç³»ç»Ÿå®Œå–„

**ä¸­ä¼˜å…ˆçº§**ï¼ˆ6-12ä¸ªæœˆï¼‰:
- ğŸ”¶ å¾®æœåŠ¡æ‹†åˆ†è¯•ç‚¹
- ğŸ”¶ Webhook é€šçŸ¥ç³»ç»Ÿ
- ğŸ”¶ è‡ªå®šä¹‰æ—¥å†è§„åˆ™

**ä½ä¼˜å…ˆçº§**ï¼ˆ12+ä¸ªæœˆï¼‰:
- ğŸ”· å…¨é¢å¾®æœåŠ¡åŒ–
- ğŸ”· æ•°æ®åˆ†æå¹³å°
- ğŸ”· ç§»åŠ¨åº”ç”¨å¼€å‘

é€šè¿‡æ¸è¿›å¼çš„æ¶æ„æ¼”è¿›ï¼ŒBili-Calendar å¯ä»¥ä»å½“å‰çš„å•ä½“åº”ç”¨é€æ­¥å‘å±•ä¸ºä¸€ä¸ªåŠŸèƒ½å®Œå–„ã€æ€§èƒ½ä¼˜å¼‚ã€å¯æ‰©å±•çš„ç°ä»£åŒ–æœåŠ¡å¹³å°ã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0.0  
**æ›´æ–°æ—¥æœŸ**: 2024  
**ä½œè€…**: GitHub Copilot  
